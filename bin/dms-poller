#!/usr/bin/ruby
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'cli'
require 'pathname'
require 'dms-poller'

VERSION = (Pathname.new(__FILE__).dirname + '../VERSION').read

settings = CLI.new do
	version VERSION
	switch	:debug,							:short => :d, :description => 'enable debugging'
	options :module_dir,				:short => :m, :cast => Pathname, :description => 'path to directory from which poller modules are loaded', :default => Pathname.new(__FILE__).dirname + '..' + 'module.d'
	switch	:startup_run,				:short => :s, :description => 'run all probes on startup (may cause load spike)'
	option	:process_limit,			:short => :l, :cast => Integer, :description => 'maximum number of scheduler run processes that can run in parallel', :default => 8
	option	:process_time_out,	:short => :o, :cast => Float, :description => 'maximum number of seconds that a scheduler run process can run', :default => 120
	option	:scheduler_quantum,	:short => :q, :cast => Float, :description => 'minimal time between scheduler runs in seconds', :default => 1.0
	option	:run_cycles,				:short => :c, :cast => Integer, :description => 'run specific number of scheduler run cycles and exit (useful for testing)'
	option	:time_scale,				:short => :t, :cast => Float, :description => 'scheduling time scale - 0.1 is 10x faster (useful for testing)', :default => 1.0
end.parse! do |settings|
	settings.module_dir.each do |m|
		fail "module directory does not exist: #{m}" unless m.directory?
	end

	settings.module_dir = settings.module_dir.map{|m| m.realpath}
end

Logging.logger.root.level = :debug if settings.debug

logging_class_name 'DMSPoller'
log.info "Starting DMS Poller version #{VERSION}; pid #{Process.pid}"

log.debug settings.inspect

poller_modules = PollerModules.new

settings.module_dir.each do |module_dir|
	poller_modules.load_directory(module_dir)
end

scheduler_thread = SchedulerThread.new(
	poller_modules, 
	settings.scheduler_quantum, 
	settings.run_cycles, 
	settings.time_scale, 
	settings.startup_run, 
	settings.process_limit,
	settings.process_time_out
)

log.info "DMS Poller ready"

begin
	scheduler_thread.join
rescue Interrupt
	log.info "interrupted, exiting..."
end

scheduler_thread.wait_run_processes

log.info "scheduler finished execution, exiting."

